<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ”€å²©è·¯çº¿AIåŠ©æ‰‹ - åˆå­¦è€…æŒ‡å—</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            color: #fff;
        }

        .app-container {
            display: flex;
            height: 100vh;
        }

        /* å·¦ä¾§æ§åˆ¶é¢æ¿ */
        .sidebar {
            width: 400px;
            min-width: 400px;
            background: rgba(0,0,0,0.3);
            border-right: 1px solid rgba(255,255,255,0.1);
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        .sidebar h1 {
            font-size: 1.3rem;
            background: linear-gradient(90deg, #00d9ff, #00ff88);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 5px;
            text-align: center;
        }

        .sidebar > p {
            color: #8892b0;
            font-size: 0.85rem;
            text-align: center;
            margin-bottom: 15px;
        }

        /* ä¸»å†…å®¹åŒº */
        .main-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* é¡¶éƒ¨å·¥å…·æ  */
        .toolbar {
            background: rgba(0,0,0,0.3);
            padding: 12px 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .toolbar-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .toolbar-label {
            color: #8892b0;
            font-size: 0.85rem;
        }

        .zoom-btn {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            border: 1px solid rgba(255,255,255,0.2);
            background: rgba(255,255,255,0.1);
            color: #fff;
            font-size: 1.2rem;
            cursor: pointer;
        }

        .zoom-btn:hover {
            background: rgba(255,255,255,0.2);
        }

        .zoom-level {
            color: #00d9ff;
            font-weight: 600;
            min-width: 50px;
            text-align: center;
        }

        .fit-btn {
            padding: 8px 12px;
            border-radius: 8px;
            border: 1px solid rgba(0,217,255,0.3);
            background: rgba(0,217,255,0.1);
            color: #00d9ff;
            font-size: 0.85rem;
            cursor: pointer;
        }

        .fit-btn:hover {
            background: rgba(0,217,255,0.2);
        }

        /* å›¾ç‰‡ç¼–è¾‘åŒº */
        .canvas-wrapper {
            flex: 1;
            overflow: auto;
            position: relative;
            background: repeating-conic-gradient(#1a1a2e 0% 25%, #0d0d1a 0% 50%) 50% / 20px 20px;
        }

        .canvas-container {
            display: inline-block;
            padding: 40px;
            min-width: 100%;
            min-height: 100%;
        }

        .upload-area {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            border: 2px dashed rgba(0,217,255,0.5);
            border-radius: 16px;
            padding: 60px 80px;
            text-align: center;
            cursor: pointer;
            background: rgba(0,217,255,0.05);
        }

        .upload-area:hover {
            border-color: #00d9ff;
            background: rgba(0,217,255,0.1);
        }

        .upload-area.hidden { display: none; }

        .upload-icon {
            font-size: 4rem;
            margin-bottom: 20px;
        }

        .upload-area h3 {
            color: #00d9ff;
            margin-bottom: 10px;
        }

        .upload-area p { color: #8892b0; }

        #fileInput { display: none; }

        #mainCanvas {
            display: block;
            cursor: crosshair;
            border-radius: 8px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
        }

        #mainCanvas.hidden { display: none; }

        /* Sectionæ ·å¼ */
        .section-title {
            color: #ccd6f6;
            font-size: 0.9rem;
            margin-bottom: 10px;
            font-weight: 600;
        }

        /* é¢œè‰²é€‰æ‹© */
        .color-options {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-bottom: 15px;
        }

        .color-btn {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: 2px solid transparent;
            cursor: pointer;
            transition: all 0.2s;
        }

        .color-btn:hover, .color-btn.selected {
            transform: scale(1.15);
            border-color: #fff;
        }

        .color-btn.green { background: #22c55e; }
        .color-btn.red { background: #ef4444; }
        .color-btn.pink { background: #ec4899; }
        .color-btn.blue { background: #3b82f6; }
        .color-btn.yellow { background: #eab308; }
        .color-btn.purple { background: #a855f7; }
        .color-btn.orange { background: #f97316; }
        .color-btn.white { background: #ffffff; }

        /* æµç¨‹æ­¥éª¤ */
        .workflow-steps {
            background: rgba(0,255,136,0.1);
            border: 1px solid rgba(0,255,136,0.3);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .workflow-steps h4 {
            color: #00ff88;
            font-size: 0.9rem;
            margin-bottom: 12px;
        }

        .workflow-step {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            margin-bottom: 10px;
            padding: 8px 10px;
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
            opacity: 0.5;
        }

        .workflow-step.active {
            opacity: 1;
            background: rgba(0,255,136,0.15);
            border: 1px solid rgba(0,255,136,0.3);
        }

        .workflow-step.completed {
            opacity: 0.8;
        }

        .workflow-step.completed .step-circle {
            background: #22c55e;
        }

        .step-circle {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: rgba(255,255,255,0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: bold;
            flex-shrink: 0;
        }

        .workflow-step.active .step-circle {
            background: linear-gradient(135deg, #00d9ff, #00ff88);
            color: #1a1a2e;
        }

        .step-text {
            flex: 1;
        }

        .step-text strong {
            display: block;
            font-size: 0.85rem;
            color: #fff;
        }

        .step-text span {
            font-size: 0.75rem;
            color: #8892b0;
        }

        /* åˆå­¦è€…æç¤º */
        .beginner-tip {
            background: linear-gradient(135deg, rgba(234,179,8,0.2), rgba(249,115,22,0.2));
            border: 1px solid rgba(234,179,8,0.4);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .beginner-tip h4 {
            color: #fbbf24;
            font-size: 0.9rem;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .beginner-tip p {
            color: #ccd6f6;
            font-size: 0.85rem;
            line-height: 1.6;
        }

        /* å²©ç‚¹æ ‡è®°æ¨¡å¼ */
        .marking-mode {
            background: rgba(0,217,255,0.1);
            border: 1px solid rgba(0,217,255,0.3);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .marking-mode h4 {
            color: #00d9ff;
            font-size: 0.9rem;
            margin-bottom: 10px;
        }

        .marking-mode p {
            color: #a0aec0;
            font-size: 0.85rem;
            margin-bottom: 12px;
            line-height: 1.5;
        }

        .hold-count {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
        }

        .hold-count .count {
            font-size: 1.8rem;
            font-weight: bold;
            color: #00ff88;
        }

        .hold-count .label {
            color: #8892b0;
            font-size: 0.85rem;
        }

        /* è·¯çº¿æ­¥éª¤åˆ—è¡¨ */
        .steps-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 0;
        }

        .steps-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .steps-header h4 {
            color: #00ff88;
            font-size: 0.9rem;
        }

        .steps-count {
            background: rgba(0,255,136,0.2);
            color: #00ff88;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
        }

        .steps-list {
            flex: 1;
            overflow-y: auto;
            margin-bottom: 15px;
        }

        .step-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 12px;
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
            margin-bottom: 6px;
            border-left: 3px solid #00d9ff;
        }

        .step-item.start { border-left-color: #22c55e; }
        .step-item.end { border-left-color: #ef4444; }

        .step-num {
            width: 28px;
            height: 28px;
            background: linear-gradient(135deg, #00d9ff, #00ff88);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 0.8rem;
            color: #1a1a2e;
            flex-shrink: 0;
        }

        .step-item.start .step-num { background: #22c55e; }
        .step-item.end .step-num { background: #ef4444; }

        .step-info {
            flex: 1;
        }

        .step-info .action {
            color: #fff;
            font-size: 0.85rem;
            font-weight: 500;
        }

        .step-info .detail {
            color: #8892b0;
            font-size: 0.75rem;
            margin-top: 2px;
        }

        .empty-steps {
            text-align: center;
            color: #8892b0;
            padding: 30px;
            font-size: 0.9rem;
        }

        /* æŒ‰é’® */
        .btn {
            width: 100%;
            padding: 12px 16px;
            border: none;
            border-radius: 10px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            margin-bottom: 8px;
            transition: all 0.2s;
        }

        .btn-primary {
            background: linear-gradient(135deg, #00d9ff, #00ff88);
            color: #1a1a2e;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,217,255,0.3);
        }

        .btn-secondary {
            background: rgba(255,255,255,0.1);
            color: #ccd6f6;
            border: 1px solid rgba(255,255,255,0.2);
        }

        .btn-secondary:hover {
            background: rgba(255,255,255,0.2);
        }

        .btn-download {
            background: linear-gradient(135deg, #f97316, #ef4444);
            color: #fff;
        }

        .btn-guide {
            background: rgba(0,255,136,0.2);
            border: 1px solid rgba(0,255,136,0.4);
            color: #00ff88;
        }

        .btn-guide:hover {
            background: rgba(0,255,136,0.3);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* è·¯çº¿è¯´æ˜å¼¹çª— */
        .route-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(26,26,46,0.95);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 30px;
        }

        .route-modal.active { display: flex; }

        .route-modal-content {
            background: linear-gradient(135deg, rgba(30,30,50,0.98), rgba(20,20,40,0.98));
            border: 1px solid rgba(0,255,136,0.3);
            border-radius: 20px;
            width: 100%;
            max-width: 1100px;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
        }

        .route-modal-header {
            padding: 20px 25px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .route-modal-header h2 {
            color: #00ff88;
            font-size: 1.3rem;
        }

        .route-modal-close {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border: none;
            background: rgba(255,255,255,0.1);
            color: #fff;
            font-size: 1.3rem;
            cursor: pointer;
        }

        .route-modal-close:hover {
            background: rgba(239,68,68,0.3);
            color: #ef4444;
        }

        .route-modal-body {
            flex: 1;
            overflow-y: auto;
            padding: 25px;
            display: grid;
            grid-template-columns: 1.2fr 1fr;
            gap: 25px;
        }

        .guide-steps-section h3 {
            color: #00d9ff;
            font-size: 1rem;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(0,217,255,0.3);
        }

        .guide-step {
            display: flex;
            gap: 12px;
            margin-bottom: 12px;
            padding: 12px;
            background: rgba(255,255,255,0.05);
            border-radius: 10px;
            border-left: 3px solid #00d9ff;
        }

        .guide-step.start-step { border-left-color: #22c55e; }
        .guide-step.end-step { border-left-color: #ef4444; }

        .guide-step-num {
            width: 32px;
            height: 32px;
            background: linear-gradient(135deg, #00d9ff, #00ff88);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 0.9rem;
            color: #1a1a2e;
            flex-shrink: 0;
        }

        .guide-step.start-step .guide-step-num { background: #22c55e; }
        .guide-step.end-step .guide-step-num { background: #ef4444; }

        .guide-step-content h5 {
            color: #fff;
            margin-bottom: 6px;
            font-size: 0.95rem;
        }

        .guide-step-content p {
            color: #a0aec0;
            font-size: 0.9rem;
            line-height: 1.5;
        }

        .guide-tips-section h3 {
            color: #eab308;
            font-size: 1rem;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(234,179,8,0.3);
        }

        .tips-box {
            background: rgba(234,179,8,0.1);
            border: 1px solid rgba(234,179,8,0.3);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .tips-box p {
            color: #ccd6f6;
            font-size: 0.9rem;
            line-height: 1.7;
        }

        .stats-box {
            background: rgba(0,217,255,0.1);
            border: 1px solid rgba(0,217,255,0.3);
            border-radius: 10px;
            padding: 15px;
        }

        .stats-box h4 {
            color: #00d9ff;
            margin-bottom: 12px;
            font-size: 0.95rem;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .stat-item {
            text-align: center;
            padding: 12px;
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
        }

        .stat-item .value {
            font-size: 1.5rem;
            font-weight: bold;
            color: #00ff88;
        }

        .stat-item .label {
            font-size: 0.8rem;
            color: #8892b0;
            margin-top: 4px;
        }

        .route-modal-footer {
            padding: 15px 25px;
            border-top: 1px solid rgba(255,255,255,0.1);
            display: flex;
            gap: 12px;
            justify-content: center;
        }

        .route-modal-footer .btn {
            width: auto;
            padding: 10px 25px;
        }

        /* åŠ è½½åŠ¨ç”» */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(26,26,46,0.95);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            flex-direction: column;
        }

        .loading-overlay.active { display: flex; }

        .spinner {
            width: 60px;
            height: 60px;
            border: 4px solid rgba(0,217,255,0.3);
            border-top-color: #00d9ff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        .loading-text {
            color: #00d9ff;
            font-size: 1.1rem;
            text-align: center;
        }

        .loading-subtext {
            color: #8892b0;
            font-size: 0.9rem;
            margin-top: 8px;
        }

        @keyframes spin { to { transform: rotate(360deg); } }

        @media (max-width: 900px) {
            .route-modal-body { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <!-- åŠ è½½åŠ¨ç”» -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner"></div>
        <p class="loading-text" id="loadingText">AIæ­£åœ¨åˆ†ææ”€å²©è·¯çº¿...</p>
        <p class="loading-subtext" id="loadingSubtext">è¯†åˆ«å²©ç‚¹ä½ç½®ï¼Œè®¡ç®—æœ€ä½³æ”€çˆ¬é¡ºåº</p>
    </div>

    <!-- è·¯çº¿è¯´æ˜å¼¹çª— -->
    <div class="route-modal" id="routeModal">
        <div class="route-modal-content">
            <div class="route-modal-header">
                <h2>ğŸ§— åˆå­¦è€…æ”€çˆ¬æŒ‡å—</h2>
                <button class="route-modal-close" id="closeRouteModal">Ã—</button>
            </div>
            <div class="route-modal-body">
                <div class="guide-steps-section">
                    <h3>ğŸªœ è¯¦ç»†æ”€çˆ¬æ­¥éª¤</h3>
                    <div id="guideSteps"></div>
                </div>
                <div class="guide-tips-section">
                    <h3>ğŸ’¡ æ–°æ‰‹å¿…è¯»æŠ€å·§</h3>
                    <div class="tips-box">
                        <p id="guideTips"></p>
                    </div>
                    <div class="stats-box">
                        <h4>ğŸ“Š è·¯çº¿ç»Ÿè®¡</h4>
                        <div class="stats-grid" id="guideStats"></div>
                    </div>
                </div>
            </div>
            <div class="route-modal-footer">
                <button class="btn btn-download" id="downloadBtnModal">ğŸ“¥ ä¸‹è½½æ ‡æ³¨å›¾ç‰‡</button>
                <button class="btn btn-secondary" id="closeRouteModalBtn">å…³é—­</button>
            </div>
        </div>
    </div>

    <div class="app-container">
        <!-- å·¦ä¾§æ§åˆ¶é¢æ¿ -->
        <div class="sidebar">
            <h1>ğŸ§— æ”€å²©è·¯çº¿AIåŠ©æ‰‹</h1>
            <p>ä¸“ä¸ºåˆå­¦è€…è®¾è®¡ - AIå¸®ä½ è§„åˆ’æ”€çˆ¬è·¯çº¿</p>

            <!-- åˆå­¦è€…æç¤º -->
            <div class="beginner-tip">
                <h4>ğŸ’¡ æ–°æ‰‹é¡»çŸ¥</h4>
                <p>ä¸çŸ¥é“æ€ä¹ˆçˆ¬ï¼Ÿæ²¡å…³ç³»ï¼åªéœ€è¦æ ‡è®°å‡ºä½ æƒ³çˆ¬çš„è·¯çº¿ä¸Šçš„æ‰€æœ‰å²©ç‚¹ï¼ŒAIä¼šè‡ªåŠ¨å¸®ä½ è§„åˆ’æ”€çˆ¬é¡ºåºï¼Œå‘Šè¯‰ä½ æ¯ä¸€æ­¥è¯¥æ€ä¹ˆåšã€‚</p>
            </div>

            <!-- æ“ä½œæµç¨‹ -->
            <div class="workflow-steps">
                <h4>ğŸ“‹ ä¸‰æ­¥å®Œæˆ</h4>
                <div class="workflow-step active" id="step1">
                    <div class="step-circle">1</div>
                    <div class="step-text">
                        <strong>ä¸Šä¼ å›¾ç‰‡</strong>
                        <span>æ‹æ‘„æˆ–ä¸Šä¼ å²©å£ç…§ç‰‡</span>
                    </div>
                </div>
                <div class="workflow-step" id="step2">
                    <div class="step-circle">2</div>
                    <div class="step-text">
                        <strong>ç‚¹å‡»æ ‡è®°å²©ç‚¹</strong>
                        <span>ç‚¹å‡»å›¾ç‰‡ä¸Šè¯¥é¢œè‰²çš„æ‰€æœ‰å²©ç‚¹</span>
                    </div>
                </div>
                <div class="workflow-step" id="step3">
                    <div class="step-circle">3</div>
                    <div class="step-text">
                        <strong>AIç”Ÿæˆæ”€çˆ¬æŒ‡å—</strong>
                        <span>è·å–è¯¦ç»†çš„æ”€çˆ¬æ­¥éª¤å’ŒæŠ€å·§</span>
                    </div>
                </div>
            </div>

            <!-- é¢œè‰²é€‰æ‹© -->
            <div class="section-title">ğŸ¨ é€‰æ‹©è·¯çº¿é¢œè‰²ï¼ˆä½ æƒ³çˆ¬å“ªæ¡çº¿ï¼Ÿï¼‰</div>
            <div class="color-options">
                <button class="color-btn green selected" data-color="green" title="ç»¿è‰²"></button>
                <button class="color-btn red" data-color="red" title="çº¢è‰²"></button>
                <button class="color-btn pink" data-color="pink" title="ç²‰è‰²"></button>
                <button class="color-btn blue" data-color="blue" title="è“è‰²"></button>
                <button class="color-btn yellow" data-color="yellow" title="é»„è‰²"></button>
                <button class="color-btn purple" data-color="purple" title="ç´«è‰²"></button>
                <button class="color-btn orange" data-color="orange" title="æ©™è‰²"></button>
                <button class="color-btn white" data-color="white" title="ç™½è‰²"></button>
            </div>

            <!-- å²©ç‚¹æ ‡è®° -->
            <div class="marking-mode" id="markingPanel" style="display: none;">
                <h4>ğŸ“ æ ‡è®°å²©ç‚¹</h4>
                <p>ç‚¹å‡»å›¾ç‰‡ä¸Š<strong>æ‰€æœ‰è¯¥é¢œè‰²</strong>çš„å²©ç‚¹ã€‚ä¸ç”¨ç®¡é¡ºåºï¼ŒAIä¼šå¸®ä½ è®¡ç®—æœ€ä½³æ”€çˆ¬è·¯çº¿ï¼</p>
                <div class="hold-count">
                    <span class="count" id="holdCount">0</span>
                    <span class="label">ä¸ªå²©ç‚¹å·²æ ‡è®°<br><small>å»ºè®®æ ‡è®°6-15ä¸ªå²©ç‚¹</small></span>
                </div>
            </div>

            <!-- è·¯çº¿é¢„è§ˆ -->
            <div class="steps-panel" id="stepsPanel" style="display: none;">
                <div class="steps-header">
                    <h4>ğŸ—ºï¸ AIè§„åˆ’çš„æ”€çˆ¬è·¯çº¿</h4>
                    <span class="steps-count" id="stepsCount">0 æ­¥</span>
                </div>
                <div class="steps-list" id="stepsList">
                    <div class="empty-steps">æ ‡è®°å²©ç‚¹åï¼ŒAIå°†ä¸ºä½ ç”Ÿæˆæ”€çˆ¬è·¯çº¿</div>
                </div>
            </div>

            <!-- æ“ä½œæŒ‰é’® -->
            <button class="btn btn-primary" id="analyzeBtn" style="display: none;">
                ğŸ¤– AIåˆ†æå¹¶ç”Ÿæˆæ”€çˆ¬æŒ‡å—
            </button>
            <button class="btn btn-download" id="downloadBtn" style="display: none;">
                ğŸ“¥ ä¸‹è½½æ ‡æ³¨å›¾ç‰‡
            </button>
            <button class="btn btn-guide" id="viewGuideBtn" style="display: none;">
                ğŸ“‹ æŸ¥çœ‹æ”€çˆ¬æŒ‡å—
            </button>
            <button class="btn btn-secondary" id="clearHoldsBtn" style="display: none;">
                ğŸ”„ æ¸…é™¤æ‰€æœ‰æ ‡è®°é‡æ–°å¼€å§‹
            </button>
        </div>

        <!-- ä¸»å†…å®¹åŒº -->
        <div class="main-area">
            <div class="toolbar">
                <div class="toolbar-group">
                    <span class="toolbar-label">ç¼©æ”¾:</span>
                    <button class="zoom-btn" id="zoomOut">âˆ’</button>
                    <span class="zoom-level" id="zoomLevel">100%</span>
                    <button class="zoom-btn" id="zoomIn">+</button>
                </div>
                <button class="fit-btn" id="fitBtn">é€‚åº”çª—å£</button>
                <button class="fit-btn" id="actualBtn">åŸå§‹å¤§å°</button>
            </div>

            <div class="canvas-wrapper" id="canvasWrapper">
                <div class="upload-area" id="uploadArea">
                    <div class="upload-icon">ğŸ“·</div>
                    <h3>ä¸Šä¼ å²©å£å›¾ç‰‡</h3>
                    <p>æ‹æ‘„æ”€å²©å¢™çš„ç…§ç‰‡ï¼Œç‚¹å‡»æˆ–æ‹–æ‹½ä¸Šä¼ </p>
                </div>
                <input type="file" id="fileInput" accept="image/*">
                <div class="canvas-container" id="canvasContainer">
                    <canvas id="mainCanvas" class="hidden"></canvas>
                </div>
            </div>
        </div>
    </div>

    <script>
        // çŠ¶æ€
        const state = {
            selectedColor: 'green',
            holds: [], // ç”¨æˆ·æ ‡è®°çš„å²©ç‚¹ {x, y}
            route: [], // AIç”Ÿæˆçš„æ”€çˆ¬è·¯çº¿ {x, y, action, description, technique}
            image: null,
            imageLoaded: false,
            zoom: 1,
            originalWidth: 0,
            originalHeight: 0,
            exportData: null,
            phase: 'upload' // 'upload' | 'marking' | 'complete'
        };
        
        const AI_API_CONFIG = {
            baseURL: "https://api.minimax.io/v1",
            apiKey: "sk-api-7PAYYO4EqTsSMU10AUiQcW2K43gnyAIyL0OIRkWzFa5Gm2H_CpN6Ls95x65NT2-3odud8PzRuCazzXiia8XGGRjsNGMbg5OpSk7PLi3snopCq6ZqGo7nv5g",   // ğŸ”´ è¿™é‡Œæ¢æˆä½ çš„ Key
            model: "MiniMax-M2.1"             
        };
        
        async function callAIForRoute(holds, imageWidth, imageHeight, colorName) {
            const res = await fetch("/api/analyze", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                holds,
                imageWidth,
                imageHeight,
                colorName
                })
            });

            if (!res.ok) {
                const text = await res.text();
                throw new Error(`API /api/analyze failed: ${res.status} ${text}`);
            }

            const data = await res.json();
            return data.route;
        }



        const colorMap = {
            green: '#22c55e', red: '#ef4444', pink: '#ec4899', blue: '#3b82f6',
            yellow: '#eab308', purple: '#a855f7', orange: '#f97316', white: '#ffffff'
        };

        const colorNames = {
            green: 'ç»¿è‰²', red: 'çº¢è‰²', pink: 'ç²‰è‰²', blue: 'è“è‰²',
            yellow: 'é»„è‰²', purple: 'ç´«è‰²', orange: 'æ©™è‰²', white: 'ç™½è‰²'
        };

        // DOM
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const canvasWrapper = document.getElementById('canvasWrapper');
        const canvas = document.getElementById('mainCanvas');
        const ctx = canvas.getContext('2d');

        function init() {
            // ä¸Šä¼ 
            uploadArea.addEventListener('click', () => fileInput.click());
            uploadArea.addEventListener('dragover', e => { e.preventDefault(); uploadArea.style.borderColor = '#00d9ff'; });
            uploadArea.addEventListener('dragleave', () => { uploadArea.style.borderColor = 'rgba(0,217,255,0.5)'; });
            uploadArea.addEventListener('drop', e => {
                e.preventDefault();
                if (e.dataTransfer.files[0]?.type.startsWith('image/')) loadImage(e.dataTransfer.files[0]);
            });
            fileInput.addEventListener('change', e => { if (e.target.files[0]) loadImage(e.target.files[0]); });

            // é¢œè‰²
            document.querySelectorAll('.color-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.color-btn').forEach(b => b.classList.remove('selected'));
                    btn.classList.add('selected');
                    state.selectedColor = btn.dataset.color;
                    redrawCanvas();
                });
            });

            // Canvasç‚¹å‡»
            canvas.addEventListener('click', handleCanvasClick);

            // ç¼©æ”¾
            document.getElementById('zoomIn').addEventListener('click', () => setZoom(state.zoom + 0.25));
            document.getElementById('zoomOut').addEventListener('click', () => setZoom(state.zoom - 0.25));
            document.getElementById('fitBtn').addEventListener('click', fitToWindow);
            document.getElementById('actualBtn').addEventListener('click', () => setZoom(1));
            canvasWrapper.addEventListener('wheel', e => {
                if (e.ctrlKey || e.metaKey) {
                    e.preventDefault();
                    setZoom(state.zoom + (e.deltaY > 0 ? -0.1 : 0.1));
                }
            });

            // æŒ‰é’®
            document.getElementById('analyzeBtn').addEventListener('click', analyzeRoute);
            document.getElementById('downloadBtn').addEventListener('click', downloadImage);
            document.getElementById('downloadBtnModal').addEventListener('click', downloadImage);
            document.getElementById('viewGuideBtn').addEventListener('click', () => document.getElementById('routeModal').classList.add('active'));
            document.getElementById('clearHoldsBtn').addEventListener('click', clearHolds);
            document.getElementById('closeRouteModal').addEventListener('click', () => document.getElementById('routeModal').classList.remove('active'));
            document.getElementById('closeRouteModalBtn').addEventListener('click', () => document.getElementById('routeModal').classList.remove('active'));
        }

        function loadImage(file) {
            const reader = new FileReader();
            reader.onload = e => {
                const img = new Image();
                img.onload = () => {
                    state.image = img;
                    state.imageLoaded = true;
                    state.originalWidth = img.width;
                    state.originalHeight = img.height;
                    uploadArea.classList.add('hidden');
                    canvas.classList.remove('hidden');

                    // æ›´æ–°çŠ¶æ€
                    state.phase = 'marking';
                    updateWorkflowUI();

                    fitToWindow();
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        function updateWorkflowUI() {
            const step1 = document.getElementById('step1');
            const step2 = document.getElementById('step2');
            const step3 = document.getElementById('step3');

            step1.classList.remove('active', 'completed');
            step2.classList.remove('active', 'completed');
            step3.classList.remove('active', 'completed');

            if (state.phase === 'upload') {
                step1.classList.add('active');
            } else if (state.phase === 'marking') {
                step1.classList.add('completed');
                step2.classList.add('active');
                document.getElementById('markingPanel').style.display = 'block';
                document.getElementById('stepsPanel').style.display = 'block';
                document.getElementById('clearHoldsBtn').style.display = 'block';
            } else if (state.phase === 'complete') {
                step1.classList.add('completed');
                step2.classList.add('completed');
                step3.classList.add('completed');
            }

            updateHoldCount();
        }

        function setZoom(newZoom) {
            state.zoom = Math.max(0.25, Math.min(4, newZoom));
            document.getElementById('zoomLevel').textContent = Math.round(state.zoom * 100) + '%';
            canvas.width = state.originalWidth * state.zoom;
            canvas.height = state.originalHeight * state.zoom;
            redrawCanvas();
        }

        function fitToWindow() {
            if (!state.image) return;
            const rect = canvasWrapper.getBoundingClientRect();
            const scale = Math.min((rect.width - 80) / state.originalWidth, (rect.height - 80) / state.originalHeight, 1);
            setZoom(scale);
        }

        function handleCanvasClick(e) {
            if (!state.imageLoaded || state.phase !== 'marking') return;

            const rect = canvas.getBoundingClientRect();
            const x = (e.clientX - rect.left) / state.zoom;
            const y = (e.clientY - rect.top) / state.zoom;

            // æ£€æŸ¥æ˜¯å¦ç‚¹å‡»äº†å·²æœ‰çš„å²©ç‚¹ï¼ˆåˆ é™¤ï¼‰
            const existingIndex = state.holds.findIndex(h => {
                const dist = Math.sqrt((h.x - x) ** 2 + (h.y - y) ** 2);
                return dist < 25;
            });

            if (existingIndex >= 0) {
                state.holds.splice(existingIndex, 1);
            } else {
                state.holds.push({ x, y });
            }

            updateHoldCount();
            redrawCanvas();
        }

        function updateHoldCount() {
            document.getElementById('holdCount').textContent = state.holds.length;

            const analyzeBtn = document.getElementById('analyzeBtn');
            if (state.holds.length >= 3 && state.phase === 'marking') {
                analyzeBtn.style.display = 'block';
                analyzeBtn.disabled = false;
            } else {
                analyzeBtn.style.display = state.phase === 'marking' ? 'block' : 'none';
                analyzeBtn.disabled = true;
            }
        }

        function redrawCanvas() {
            if (!state.image) return;
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.drawImage(state.image, 0, 0, canvas.width, canvas.height);

            const z = state.zoom;
            const mainColor = colorMap[state.selectedColor];

            if (state.phase === 'marking') {
                // ç”»å²©ç‚¹æ ‡è®°ï¼ˆç®€å•åœ†ç‚¹ï¼‰
                state.holds.forEach((hold, index) => {
                    ctx.beginPath();
                    ctx.arc(hold.x * z, hold.y * z, 18 * z, 0, Math.PI * 2);
                    ctx.fillStyle = mainColor;
                    ctx.globalAlpha = 0.8;
                    ctx.fill();
                    ctx.globalAlpha = 1;
                    ctx.strokeStyle = '#fff';
                    ctx.lineWidth = 3 * z;
                    ctx.stroke();

                    // å°æ•°å­—
                    ctx.fillStyle = '#fff';
                    ctx.font = `bold ${12 * z}px sans-serif`;
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.fillText(String(index + 1), hold.x * z, hold.y * z);
                });
            } else if (state.phase === 'complete' && state.route.length > 0) {
                // ç”»è¿æ¥ç®­å¤´
                for (let i = 0; i < state.route.length - 1; i++) {
                    drawArrowOnCanvas(
                        state.route[i].x * z, state.route[i].y * z,
                        state.route[i+1].x * z, state.route[i+1].y * z,
                        mainColor
                    );
                }

                // ç”»è·¯çº¿ç‚¹
                state.route.forEach((step, index) => {
                    let color = mainColor;
                    let label = String(index + 1);

                    if (index === 0) { color = '#22c55e'; label = 'èµ·'; }
                    else if (index === state.route.length - 1) { color = '#ef4444'; label = 'ç»ˆ'; }
                    else if (step.action.includes('è„š')) { color = '#64748b'; }

                    drawLabeledPointOnCanvas(step.x * z, step.y * z, color, label, step.action, 20 * z);
                });
            }
        }

        function drawArrowOnCanvas(x1, y1, x2, y2, color) {
            const dx = x2 - x1, dy = y2 - y1;
            const angle = Math.atan2(dy, dx);
            const dist = Math.sqrt(dx*dx + dy*dy);
            const shorten = 25 * state.zoom;

            if (dist < shorten * 2) return;

            const ratio = (dist - shorten) / dist;
            const startX = x1 + dx * (shorten/dist), startY = y1 + dy * (shorten/dist);
            const endX = x1 + dx * ratio, endY = y1 + dy * ratio;

            ctx.beginPath();
            ctx.moveTo(startX, startY);
            ctx.lineTo(endX, endY);
            ctx.strokeStyle = color;
            ctx.lineWidth = 3 * state.zoom;
            ctx.stroke();

            // ç®­å¤´
            const arrowSize = 10 * state.zoom;
            ctx.beginPath();
            ctx.moveTo(endX, endY);
            ctx.lineTo(endX - arrowSize*Math.cos(angle-Math.PI/6), endY - arrowSize*Math.sin(angle-Math.PI/6));
            ctx.moveTo(endX, endY);
            ctx.lineTo(endX - arrowSize*Math.cos(angle+Math.PI/6), endY - arrowSize*Math.sin(angle+Math.PI/6));
            ctx.stroke();
        }

        function drawLabeledPointOnCanvas(x, y, color, label, action, radius) {
            // å¤–åœˆ
            ctx.beginPath();
            ctx.arc(x, y, radius + 3 * state.zoom, 0, Math.PI * 2);
            ctx.strokeStyle = '#fff';
            ctx.lineWidth = 3 * state.zoom;
            ctx.stroke();

            // å†…åœ†
            ctx.beginPath();
            ctx.arc(x, y, radius, 0, Math.PI * 2);
            ctx.fillStyle = color;
            ctx.fill();

            // æ•°å­—
            ctx.fillStyle = '#fff';
            ctx.font = `bold ${radius * 0.8}px sans-serif`;
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText(label, x, y);

            // åŠ¨ä½œæ ‡ç­¾
            if (action && label !== 'èµ·' && label !== 'ç»ˆ') {
                ctx.font = `bold ${11 * state.zoom}px sans-serif`;
                const textWidth = ctx.measureText(action).width;
                const labelX = x + radius + 8 * state.zoom;

                ctx.fillStyle = 'rgba(0,0,0,0.85)';
                ctx.beginPath();
                ctx.roundRect(labelX - 4 * state.zoom, y - 9 * state.zoom, textWidth + 8 * state.zoom, 18 * state.zoom, 4 * state.zoom);
                ctx.fill();

                ctx.fillStyle = '#fff';
                ctx.textAlign = 'left';
                ctx.fillText(action, labelX, y);
            }
        }

        async function analyzeRoute() {
            if (state.holds.length < 3) return;
            
            document.getElementById('loadingOverlay').classList.add('active');
            
            try {
                const aiRoute = await callAIForRoute(
                    state.holds,
                    state.originalWidth,
                    state.originalHeight,
                    colorNames[state.selectedColor]
                );

                state.route = aiRoute;
                state.phase = 'complete';

                generateFinalImage();
                generateGuide();
                updateRouteList();

                document.getElementById('analyzeBtn').style.display = 'none';
                document.getElementById('downloadBtn').style.display = 'block';
                document.getElementById('viewGuideBtn').style.display = 'block';

                updateWorkflowUI();
                redrawCanvas();

                document.getElementById('routeModal').classList.add('active');

            } catch (err) {
                alert("AI åˆ†æå¤±è´¥ï¼Œè¯·æ£€æŸ¥ API Key æˆ–ç½‘ç»œ");
                console.error(err);
            } finally {
                document.getElementById('loadingOverlay').classList.remove('active');
            }
        }


        // AIæ ¸å¿ƒç®—æ³•ï¼šè®¡ç®—æœ€ä½³æ”€çˆ¬è·¯çº¿
        function calculateClimbingRoute(holds) {
            if (holds.length === 0) return [];

            // 1. æŒ‰Yåæ ‡æ’åºï¼ˆä»ä¸‹åˆ°ä¸Šï¼‰
            const sortedByY = [...holds].sort((a, b) => b.y - a.y);

            // 2. æ‰¾åˆ°èµ·ç‚¹ï¼ˆæœ€ä¸‹é¢çš„2ä¸ªç‚¹ä½œä¸ºèµ·æ­¥æ‰‹ç‚¹ï¼‰
            const startHolds = sortedByY.slice(0, Math.min(2, holds.length));

            // 3. æ‰¾åˆ°ç»ˆç‚¹ï¼ˆæœ€ä¸Šé¢çš„ç‚¹ï¼‰
            const endHold = sortedByY[sortedByY.length - 1];

            // 4. è´ªå¿ƒç®—æ³•ï¼šä»ä¸‹å¾€ä¸Šï¼Œäº¤æ›¿é€‰æ‹©å·¦å³æ‰‹/è„š
            const route = [];
            const used = new Set();

            // èµ·ç‚¹
            if (startHolds.length >= 2) {
                const leftStart = startHolds[0].x < startHolds[1].x ? startHolds[0] : startHolds[1];
                const rightStart = startHolds[0].x < startHolds[1].x ? startHolds[1] : startHolds[0];

                route.push({ ...leftStart, action: 'å·¦æ‰‹èµ·æ­¥', isStart: true });
                route.push({ ...rightStart, action: 'å³æ‰‹èµ·æ­¥', isStart: true });
                used.add(JSON.stringify(leftStart));
                used.add(JSON.stringify(rightStart));
            } else {
                route.push({ ...startHolds[0], action: 'åŒæ‰‹èµ·æ­¥', isStart: true });
                used.add(JSON.stringify(startHolds[0]));
            }

            // ä¸­é—´è·¯çº¿ï¼šè´ªå¿ƒé€‰æ‹©æœ€è¿‘çš„æœªä½¿ç”¨å²©ç‚¹
            let lastPos = {
                x: (startHolds[0].x + (startHolds[1]?.x || startHolds[0].x)) / 2,
                y: startHolds[0].y
            };

            // äº¤æ›¿ä½¿ç”¨æ‰‹è„š
            const actionSequence = ['å·¦è„š', 'å³æ‰‹', 'å³è„š', 'å·¦æ‰‹'];
            let actionIndex = 0;

            // æŒ‰é«˜åº¦åˆ†å±‚å¤„ç†
            const remainingHolds = holds.filter(h => !used.has(JSON.stringify(h)));
            const layers = [];

            // æŠŠå‰©ä½™å²©ç‚¹åˆ†æˆè‹¥å¹²å±‚
            const layerHeight = (startHolds[0].y - endHold.y) / Math.max(4, Math.ceil(remainingHolds.length / 2));

            remainingHolds.forEach(hold => {
                const layerIndex = Math.floor((startHolds[0].y - hold.y) / layerHeight);
                if (!layers[layerIndex]) layers[layerIndex] = [];
                layers[layerIndex].push(hold);
            });

            // é€å±‚å¤„ç†
            layers.forEach((layer, layerIdx) => {
                if (!layer) return;

                // æŒ‰Xæ’åº
                layer.sort((a, b) => a.x - b.x);

                layer.forEach(hold => {
                    if (used.has(JSON.stringify(hold))) return;

                    const action = actionSequence[actionIndex % actionSequence.length];

                    // æ ¹æ®ä½ç½®è°ƒæ•´åŠ¨ä½œ
                    let finalAction = action;
                    const centerX = state.originalWidth / 2;

                    if (action.includes('æ‰‹')) {
                        if (hold.x < centerX - 50) finalAction = 'å·¦æ‰‹';
                        else if (hold.x > centerX + 50) finalAction = 'å³æ‰‹';
                    } else {
                        if (hold.x < centerX - 30) finalAction = 'å·¦è„š';
                        else if (hold.x > centerX + 30) finalAction = 'å³è„š';
                    }

                    route.push({ ...hold, action: finalAction });
                    used.add(JSON.stringify(hold));
                    actionIndex++;
                });
            });

            // ç»ˆç‚¹
            if (!used.has(JSON.stringify(endHold))) {
                route.push({ ...endHold, action: 'å®Œæˆæ”€ç™»', isEnd: true });
            } else {
                route[route.length - 1].isEnd = true;
                route[route.length - 1].action = 'å®Œæˆæ”€ç™»';
            }

            // ä¸ºæ¯ä¸ªæ­¥éª¤ç”Ÿæˆè¯¦ç»†è¯´æ˜
            route.forEach((step, index) => {
                step.description = generateStepDescription(step, index, route);
                step.technique = generateTechnique(step, index, route);
            });

            return route;
        }

        function generateStepDescription(step, index, route) {
            if (step.isStart) {
                return 'åŒæ‰‹æ‰¾åˆ°èµ·ç‚¹å²©ç‚¹ï¼Œèº«ä½“è´´è¿‘å²©å£ï¼Œé‡å¿ƒæ”¾ä½ï¼Œå‡†å¤‡å¼€å§‹æ”€çˆ¬ã€‚';
            }
            if (step.isEnd) {
                return 'æœ€åå†²åˆºï¼åŒæ‰‹æŠ“ç¨³é¡¶ç‚¹ï¼Œä¿æŒ3ç§’ç¡®è®¤å®Œæˆã€‚æ­å–œä½ å®Œæˆæ”€ç™»ï¼';
            }

            const prevStep = route[index - 1];
            if (!prevStep) return step.action;

            const dx = step.x - prevStep.x;
            const dy = step.y - prevStep.y;
            const distance = Math.sqrt(dx * dx + dy * dy);

            let desc = '';

            if (step.action.includes('æ‰‹')) {
                desc = step.action + 'å‘';
                if (dy < -50) desc += 'ä¸Šæ–¹';
                if (dx > 30) desc += 'å³ä¾§';
                else if (dx < -30) desc += 'å·¦ä¾§';
                desc += 'ç§»åŠ¨æŠ“æ¡ã€‚';

                if (distance > 100) {
                    desc += 'è·¨åº¦è¾ƒå¤§ï¼Œéœ€è¦å…ˆç§»åŠ¨é‡å¿ƒã€‚';
                }
            } else {
                desc = step.action + 'è¸©è¸';
                if (dy < -30) desc += 'ä¸Šæ–¹';
                if (dx > 20) desc += 'å³ä¾§';
                else if (dx < -20) desc += 'å·¦ä¾§';
                desc += 'å²©ç‚¹ã€‚';

                desc += 'ç”¨è„šå°–å†…ä¾§ç²¾å‡†è¸©ç‚¹ï¼Œè¸©ç¨³åå†è½¬ç§»é‡å¿ƒã€‚';
            }

            return desc;
        }

        function generateTechnique(step, index, route) {
            if (step.isStart) {
                return 'ä¸‰ç‚¹å›ºå®šåŸåˆ™ï¼šç§»åŠ¨ä¸€ä¸ªè‚¢ä½“æ—¶ï¼Œä¿æŒå…¶ä»–ä¸‰ä¸ªè‚¢ä½“ç¨³å®šã€‚';
            }
            if (step.isEnd) {
                return 'æœ€åä¸€æ­¥å¯ä»¥é€‚å½“åŠ¨æ€å‘åŠ›ï¼Œä½†è¦ç¡®ä¿æŠ“ç¨³ã€‚';
            }

            const tips = [];

            if (step.action.includes('æ‰‹')) {
                tips.push('æ ¹æ®å²©ç‚¹å½¢çŠ¶é€‰æ‹©æŠ“æ¡æ–¹å¼ï¼šæŒ‡æ´ç”¨æŒ‡å°–æŠ ã€å¹³å°ç”¨æŒå¿ƒåŒ…ã€ä¾§æ‹‰ç”¨æŒ‡èŠ‚å‹¾');
            } else {
                tips.push('è„šè¸©ç¨³åå†ç§»åŠ¨é‡å¿ƒï¼Œé¿å…æ‰“æ»‘');
            }

            const prevStep = route[index - 1];
            if (prevStep) {
                const dy = step.y - prevStep.y;
                if (dy < -80) {
                    tips.push('å‘ä¸Šç§»åŠ¨æ—¶å¤šç”¨è…¿éƒ¨å‘åŠ›ï¼Œæ‰‹è‡‚ä¸»è¦ä¿æŒå¹³è¡¡');
                }
            }

            return tips.join('ã€‚') + 'ã€‚';
        }

        function updateRouteList() {
            const container = document.getElementById('stepsList');
            document.getElementById('stepsCount').textContent = `${state.route.length} æ­¥`;

            if (state.route.length === 0) {
                container.innerHTML = '<div class="empty-steps">AIå°†ä¸ºä½ ç”Ÿæˆæ”€çˆ¬è·¯çº¿</div>';
                return;
            }

            let html = '';
            state.route.forEach((step, index) => {
                const isStart = step.isStart;
                const isEnd = step.isEnd;
                const stepClass = isStart ? 'start' : (isEnd ? 'end' : '');

                html += `
                    <div class="step-item ${stepClass}">
                        <div class="step-num">${index + 1}</div>
                        <div class="step-info">
                            <div class="action">${step.action}</div>
                            <div class="detail">${step.description.slice(0, 30)}...</div>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        function generateFinalImage() {
            const exportCanvas = document.createElement('canvas');
            exportCanvas.width = state.originalWidth;
            exportCanvas.height = state.originalHeight;
            const exportCtx = exportCanvas.getContext('2d');
            exportCtx.drawImage(state.image, 0, 0);

            const mainColor = colorMap[state.selectedColor];

            // ç”»ç®­å¤´
            for (let i = 0; i < state.route.length - 1; i++) {
                drawArrowExport(exportCtx, state.route[i].x, state.route[i].y, state.route[i+1].x, state.route[i+1].y, mainColor);
            }

            // ç”»ç‚¹å’Œæ ‡ç­¾
            state.route.forEach((step, index) => {
                let color = mainColor;
                let label = `${index + 1}. ${step.action}`;

                if (step.isStart) { color = '#22c55e'; label = 'èµ·æ­¥'; }
                else if (step.isEnd) { color = '#ef4444'; label = 'ç»ˆç‚¹'; }
                else if (step.action.includes('è„š')) { color = '#64748b'; }

                drawLabeledPointExport(exportCtx, step.x, step.y, color, label, 22);
            });

            state.exportData = exportCanvas.toDataURL('image/png');
        }

        function drawArrowExport(ctx, x1, y1, x2, y2, color) {
            const dx = x2 - x1, dy = y2 - y1;
            const angle = Math.atan2(dy, dx);
            const dist = Math.sqrt(dx*dx + dy*dy);
            const shorten = 28;

            if (dist < shorten * 2) return;

            const ratio = (dist - shorten) / dist;
            const startX = x1 + dx * (shorten/dist), startY = y1 + dy * (shorten/dist);
            const endX = x1 + dx * ratio, endY = y1 + dy * ratio;

            ctx.beginPath();
            ctx.moveTo(startX, startY);
            ctx.lineTo(endX, endY);
            ctx.strokeStyle = color;
            ctx.lineWidth = 4;
            ctx.stroke();

            ctx.beginPath();
            ctx.moveTo(endX, endY);
            ctx.lineTo(endX - 12*Math.cos(angle-Math.PI/6), endY - 12*Math.sin(angle-Math.PI/6));
            ctx.moveTo(endX, endY);
            ctx.lineTo(endX - 12*Math.cos(angle+Math.PI/6), endY - 12*Math.sin(angle+Math.PI/6));
            ctx.stroke();
        }

        function drawLabeledPointExport(ctx, x, y, color, label, radius) {
            ctx.beginPath();
            ctx.arc(x, y, radius, 0, Math.PI * 2);
            ctx.fillStyle = color;
            ctx.fill();
            ctx.strokeStyle = '#fff';
            ctx.lineWidth = 3;
            ctx.stroke();

            ctx.font = 'bold 13px sans-serif';
            const textWidth = ctx.measureText(label).width;
            const labelX = x + radius + 6;

            ctx.fillStyle = 'rgba(0,0,0,0.85)';
            ctx.beginPath();
            ctx.roundRect(labelX - 4, y - 10, textWidth + 8, 20, 4);
            ctx.fill();

            ctx.fillStyle = '#fff';
            ctx.textAlign = 'left';
            ctx.textBaseline = 'middle';
            ctx.fillText(label, labelX, y);
        }

        function generateGuide() {
            let html = '';

            state.route.forEach((step, index) => {
                const isStart = step.isStart;
                const isEnd = step.isEnd;
                const stepClass = isStart ? 'start-step' : (isEnd ? 'end-step' : '');

                html += `
                    <div class="guide-step ${stepClass}">
                        <div class="guide-step-num">${index + 1}</div>
                        <div class="guide-step-content">
                            <h5>ç¬¬${index + 1}æ­¥ï¼š${step.action}</h5>
                            <p><strong>åŠ¨ä½œï¼š</strong>${step.description}</p>
                            <p style="color: #fbbf24; margin-top: 6px;"><strong>ğŸ’¡ æŠ€å·§ï¼š</strong>${step.technique}</p>
                        </div>
                    </div>
                `;
            });

            document.getElementById('guideSteps').innerHTML = html;

            // ç»Ÿè®¡
            const handSteps = state.route.filter(s => s.action.includes('æ‰‹')).length;
            const footSteps = state.route.filter(s => s.action.includes('è„š')).length;

            document.getElementById('guideStats').innerHTML = `
                <div class="stat-item">
                    <div class="value">${state.route.length}</div>
                    <div class="label">æ€»æ­¥æ•°</div>
                </div>
                <div class="stat-item">
                    <div class="value" style="color: ${colorMap[state.selectedColor]}">${colorNames[state.selectedColor]}</div>
                    <div class="label">è·¯çº¿é¢œè‰²</div>
                </div>
                <div class="stat-item">
                    <div class="value">${handSteps}</div>
                    <div class="label">æ‰‹éƒ¨åŠ¨ä½œ</div>
                </div>
                <div class="stat-item">
                    <div class="value">${footSteps}</div>
                    <div class="label">è„šéƒ¨åŠ¨ä½œ</div>
                </div>
            `;

            // æŠ€å·§
            const tips = [
                'â€¢ <strong>æ”€çˆ¬å‰å…ˆè§‚å¯Ÿ</strong>ï¼šåœ¨è„‘ä¸­é¢„æ¼”æ•´æ¡è·¯çº¿ï¼Œæƒ³è±¡æ¯ä¸€æ­¥çš„åŠ¨ä½œ',
                'â€¢ <strong>ä¸‰ç‚¹å›ºå®šåŸåˆ™</strong>ï¼šç§»åŠ¨ä¸€ä¸ªè‚¢ä½“æ—¶ï¼Œå…¶ä»–ä¸‰ä¸ªä¿æŒç¨³å®šæŠ“æ¡æˆ–è¸©è¸',
                'â€¢ <strong>å¤šç”¨è…¿éƒ¨å‘åŠ›</strong>ï¼šè…¿éƒ¨åŠ›é‡æ˜¯æ‰‹è‡‚çš„3-4å€ï¼Œå°½é‡ç”¨è…¿æ¨åŠ¨èº«ä½“å‘ä¸Š',
                'â€¢ <strong>èº«ä½“è´´è¿‘å²©å£</strong>ï¼šé‡å¿ƒé è¿‘å²©å£å¯ä»¥å‡å°‘æ‰‹è‡‚è´Ÿæ‹…',
                'â€¢ <strong>å‘¼å¸å‡åŒ€</strong>ï¼šå‘åŠ›æ—¶å‘¼æ°”ï¼Œä¸è¦æ†‹æ°”',
                'â€¢ <strong>æ”¾æ¾æ‰‹è‡‚</strong>ï¼šåœ¨ç¨³å®šä½ç½®æ—¶è®©æ‰‹è‡‚è‡ªç„¶ä¸‹å‚ï¼Œæ¢å¤è‚Œè‚‰'
            ];

            if (state.route.length > 8) {
                tips.push('â€¢ <strong>è·¯çº¿è¾ƒé•¿</strong>ï¼šåœ¨ç¨³å®šç‚¹ä½é€‚å½“ä¼‘æ¯ï¼Œè°ƒæ•´å‘¼å¸');
            }

            document.getElementById('guideTips').innerHTML = tips.join('<br><br>');
        }

        function downloadImage() {
            const link = document.createElement('a');
            link.download = `æ”€å²©è·¯çº¿-${colorNames[state.selectedColor]}-${Date.now()}.png`;
            link.href = state.exportData;
            link.click();
        }

        function clearHolds() {
            state.holds = [];
            state.route = [];
            state.phase = 'marking';

            document.getElementById('analyzeBtn').style.display = 'block';
            document.getElementById('downloadBtn').style.display = 'none';
            document.getElementById('viewGuideBtn').style.display = 'none';

            updateWorkflowUI();
            updateHoldCount();
            redrawCanvas();

            document.getElementById('stepsList').innerHTML = '<div class="empty-steps">æ ‡è®°å²©ç‚¹åï¼ŒAIå°†ä¸ºä½ ç”Ÿæˆæ”€çˆ¬è·¯çº¿</div>';
            document.getElementById('stepsCount').textContent = '0 æ­¥';
        }

        init();
    </script>
</body>
</html>
